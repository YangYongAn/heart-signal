# 歌词生成工具

使用 OpenAI Whisper（tiny 模型）从音频文件自动生成 KTV 风格的逐字时间轴歌词。

## 🚀 快速开始

### 1. 安装依赖

```bash
pip3 install openai-whisper
```

首次运行时会自动下载 tiny 模型（约 72MB）。

### 2. 生成歌词

```bash
cd scripts
python3 generate_lyrics.py ../assets/music.wav
# 自动生成: ../assets/music_lyric.txt
```

### 3. 启动应用

```bash
pnpm dev
```

歌词文件会自动被加载，无需手动修改代码。

---

## 📝 歌词格式说明

### 文本格式（推荐使用）

```
那(0.00+0.52)就(0.52+0.52)不(1.04+0.55)要(1.59+0.55)
如(7.10+0.37)果(7.47+0.37)渐(7.84+0.62)
```

**格式**：`字(开始时间+持续时间)字(开始时间+持续时间)...`

**规则**：
- 同一行的字是连续的（时间相邻）
- 换行表示时间间隙（新句子）
- 时间单位：秒（支持小数）

**示例解析**：
- `那(0.00+0.52)` - "那"字从 0 秒开始，持续 0.52 秒
- `就(0.52+0.52)` - "就"字从 0.52 秒开始，持续 0.52 秒（与"那"相邻）
- 换行后的`如(7.10+0.37)` - "如"字从 7.1 秒开始（与前面有时间间隙）

### 其他格式

脚本同时生成：
- `lyrics.json` - JSON 数组格式（备用）
- `lyrics.ts` - TypeScript 数组格式（备用）
- `lyrics.txt` - 文本格式（推荐）

---

## 📂 使用流程

### 步骤 1: 生成歌词

```bash
python3 generate_lyrics.py ../assets/music.wav
```

**输出**：
```
✅ JSON 歌词已保存: lyrics.json
✅ TypeScript 歌词已保存: lyrics.ts
✅ 文本格式已保存: lyrics.txt

📝 文本格式预览（共 2 句）:
  那(0.00+0.52)就(0.52+0.52)不(1.04+0.55)...
  如(7.10+0.37)果(7.47+0.37)...
```

### 步骤 2: 验证生成结果

歌词文件自动生成到：
```
assets/music_lyric.txt
```

例如内容如下：
```
那(0.00+0.52)就(0.52+0.52)不(1.04+0.55)要(1.59+0.55)留(2.14+1.28)失(3.42+0.52)放(3.94+0.32)一(4.26+0.46)波(4.72+0.30)不(5.02+0.42)再(5.44+0.32)有(5.76+1.34)
如(7.10+0.37)果(7.47+0.37)渐(7.84+0.62)有(8.46+0.36)此(8.82+0.36)生(9.18+0.70)有(9.88+0.38)很(10.26+0.34)有(10.60+0.34)太(10.94+0.50)重(11.44+0.38)痛(11.82+1.18)
```

### 步骤 3: 启动应用

```bash
pnpm dev
```

应用启动时会自动从服务器加载 `assets/music_lyric.txt` 文件。

### 步骤 4: 完成

代码会自动解析文本格式，生成歌词数据供歌词管理器使用。无需手动修改代码。

---

## 🔧 高级选项

### 使用更大的模型

如果 tiny 模型识别不准确，修改脚本中的模型选择：

```python
# 在 generate_lyrics.py 中修改这一行：
model = whisper.load_model("tiny")  # 改为 "base"、"small" 等
```

**模型对比**：

| 模型 | 大小 | 速度 | 精度 | 适用场景 |
|------|------|------|------|---------|
| tiny | ~72MB | 最快 | 中等 | ⭐ 推荐（大多数场景） |
| base | ~142MB | 快 | 良好 | 精度要求较高 |
| small | ~461MB | 中等 | 很好 | 背景音乐较多 |
| medium | ~1.5GB | 慢 | 优秀 | 对精度要求高 |
| large | ~2.9GB | 很慢 | 最佳 | 对精度要求极高 |

### 手动调整

如果识别不完美，可以手动编辑 `assets/music_lyric.txt`：

```
# 修改前
那(0.00+0.52)就(0.52+0.52)不(1.04+0.55)

# 修改后（调整时间）
那(0.00+0.55)就(0.55+0.50)不(1.05+0.54)
```

修改后刷新页面即可生效（无需重启服务器）。

---

## ⚠️ 注意事项

1. **识别准确度** - Whisper 对歌曲识别可能不如语音准确，建议手动检查
2. **音频质量** - 清晰的发音、较低的背景音量有助于提高识别精度
3. **语言** - 脚本默认识别中文，其他语言需修改代码
4. **时间误差** - 自动识别的时间轴可能有 0.1-0.5 秒的偏差，可手动调整

---

## 🐛 故障排除

### ImportError: No module named 'whisper'

安装依赖：
```bash
pip3 install openai-whisper
```

### 识别效果不好

1. 尝试使用更大的模型（base 或 small）
2. 确保音频清晰，背景音乐不要太大
3. 手动调整时间轴

### 文件编码问题

确保文本编辑器使用 UTF-8 编码保存文件。

---

## 📚 输出说明

脚本生成单个文件：

- **music_lyric.txt** - 文本格式歌词文件，自动保存在音频文件同目录

该文件会被自动提供给前端页面，无需手动处理。
